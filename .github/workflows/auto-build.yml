name: Auto Increment Runtime Build

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  bump-build:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout runtime repo
      # -----------------------------
      - name: Checkout StreamSuites runtime
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------
      # Checkout dashboard repo
      # -----------------------------
      - name: Checkout StreamSuites-Dashboard
        uses: actions/checkout@v4
        with:
          repository: BSMediaGroup/StreamSuites-Dashboard
          token: ${{ secrets.DASHBOARD_PUSH_TOKEN }}
          path: StreamSuites-Dashboard

      # -----------------------------
      # Set up Python
      # -----------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -----------------------------
      # Calculate next build number
      # -----------------------------
      - name: Calculate next build number
        id: build
        run: |
          python <<'PYCODE'
          from datetime import datetime
          import os
          import re
          from pathlib import Path

          version_file = Path("runtime/version.py")
          text = version_file.read_text(encoding="utf-8")

          match = re.search(r'^BUILD = "([^"]+)"$', text, re.MULTILINE)
          if not match:
              raise RuntimeError("BUILD not found in runtime/version.py")

          current = match.group(1)
          today = datetime.utcnow().strftime("%Y.%m.%d")

          if "+" in current:
              date_part, counter = current.split("+", 1)
              next_counter = int(counter) + 1 if date_part == today else 1
          else:
              next_counter = 1

          next_build = f"{today}+{next_counter:03d}"

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as output:
              output.write(f"next_build={next_build}\n")
          PYCODE

      # -----------------------------
      # Update runtime + dashboard versions
      # -----------------------------
      - name: Update version metadata (runtime authoritative)
        run: |
          python scripts/update_version.py \
            0.2.3-alpha \
            --build "${{ steps.build.outputs.next_build }}" \
            --dashboard-root StreamSuites-Dashboard/docs

      # -----------------------------
      # Commit runtime changes
      # -----------------------------
      - name: Commit runtime version update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add runtime/version.py changelog runtime/exports || true
          git diff --cached --quiet || \
            git commit -m "chore(runtime): bump build to ${{ steps.build.outputs.next_build }}"

      # -----------------------------
      # Push runtime changes
      # -----------------------------
      - name: Push runtime changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/BSMediaGroup/StreamSuites.git

      # -----------------------------
      # Commit dashboard changes (SKIP STATE PIPELINE)
      # -----------------------------
      - name: Commit dashboard version sync
        run: |
          cd StreamSuites-Dashboard

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/version.json docs/about docs/data || true
          git diff --cached --quiet || \
            git commit -m "chore(dashboard): sync version ${{ steps.build.outputs.next_build }} [skip dashboard-state]"

      # -----------------------------
      # Push dashboard changes
      # -----------------------------
      - name: Push dashboard changes
        env:
          DASHBOARD_PUSH_TOKEN: ${{ secrets.DASHBOARD_PUSH_TOKEN }}
        run: |
          cd StreamSuites-Dashboard
          git push https://x-access-token:${DASHBOARD_PUSH_TOKEN}@github.com/BSMediaGroup/StreamSuites-Dashboard.git
