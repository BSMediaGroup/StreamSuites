name: Auto Increment Runtime Build

on:
  push:
    branches:
      - main
    paths-ignore:
      # Prevent self-trigger loop on files this workflow writes
      - "runtime/version.py"
      - "runtime/exports/**"
      - "changelog/**"
      - ".github/workflows/**"

permissions:
  contents: write

concurrency:
  group: runtime-auto-build-bump
  cancel-in-progress: false

jobs:
  bump-build:
    # Hard guard: do not run on auto-build commits
    if: "!contains(github.event.head_commit.message, '[auto-build]')"
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout runtime repo
      # -----------------------------
      - name: Checkout StreamSuites runtime
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------
      # Checkout dashboard repo
      # -----------------------------
      - name: Checkout StreamSuites-Dashboard
        uses: actions/checkout@v4
        with:
          repository: BSMediaGroup/StreamSuites-Dashboard
          token: ${{ secrets.DASHBOARD_PUSH_TOKEN }}
          path: StreamSuites-Dashboard

      # -----------------------------
      # Set up Python
      # -----------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -----------------------------
      # Network diagnostics (DEBUG)
      # -----------------------------
      - name: Network diagnostics
        run: |
          nslookup github.com
          curl -I https://github.com || true

      # -----------------------------
      # Calculate next build number
      # -----------------------------
      - name: Calculate next build number
        id: build
        run: |
          python <<'PYCODE'
          from datetime import datetime
          import os
          import re
          from pathlib import Path

          version_file = Path("runtime/version.py")
          text = version_file.read_text(encoding="utf-8")

          match = re.search(r'^BUILD = "([^"]+)"$', text, re.MULTILINE)
          if not match:
              raise RuntimeError("BUILD not found in runtime/version.py")

          current = match.group(1)
          today = datetime.utcnow().strftime("%Y.%m.%d")

          if "+" in current:
              date_part, counter = current.split("+", 1)
              next_counter = int(counter) + 1 if date_part == today else 1
          else:
              next_counter = 1

          next_build = f"{today}+{next_counter:03d}"

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as output:
              output.write(f"next_build={next_build}\n")
          PYCODE

      # -----------------------------
      # Update runtime + dashboard versions (runtime authoritative)
      # -----------------------------
      - name: Update version metadata (runtime authoritative)
        run: |
          python scripts/update_version.py \
            0.2.3-alpha \
            --build "${{ steps.build.outputs.next_build }}" \
            --dashboard-root StreamSuites-Dashboard/docs

      # -----------------------------
      # Commit runtime changes
      # -----------------------------
      - name: Commit runtime version update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add runtime/version.py changelog runtime/exports || true
          git diff --cached --quiet || \
            git commit -m "chore(runtime): bump build to ${{ steps.build.outputs.next_build }} [auto-build]"

      # -----------------------------
      # Rebase onto latest main BEFORE push (CRITICAL)
      # -----------------------------
      - name: Rebase onto latest main
        run: |
          git fetch origin
          git pull --rebase origin main

      # -----------------------------
      # Push runtime changes (with retry + backoff)
      # -----------------------------
      - name: Push runtime changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          for attempt in 1 2 3 4 5; do
            echo "Push attempt $attempt..."
            if git push https://x-access-token:${GITHUB_TOKEN}@github.com/BSMediaGroup/StreamSuites.git; then
              echo "Push succeeded"
              exit 0
            fi
            echo "Push failed â€” retrying in $((attempt * 10)) seconds..."
            sleep $((attempt * 10))
          done

          echo "Push failed after 5 attempts"
          exit 1

      # -----------------------------
      # Sync runtime snapshots into dashboard
      # -----------------------------
      - name: Sync runtime snapshots into dashboard
        run: |
          mkdir -p StreamSuites-Dashboard/docs/shared/state
          rsync -av --delete \
            runtime/exports/ \
            StreamSuites-Dashboard/docs/shared/state/

      # -----------------------------
      # Commit dashboard changes (single commit)
      # -----------------------------
      - name: Commit dashboard sync
        run: |
          cd StreamSuites-Dashboard

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/version.json docs/about docs/data docs/shared/state || true
          git diff --cached --quiet || \
            git commit -m "chore(dashboard): sync build ${{ steps.build.outputs.next_build }} [auto-build]"

      # -----------------------------
      # Push dashboard changes
      # -----------------------------
      - name: Push dashboard changes
        env:
          DASHBOARD_PUSH_TOKEN: ${{ secrets.DASHBOARD_PUSH_TOKEN }}
        run: |
          cd StreamSuites-Dashboard
          git push https://x-access-token:${DASHBOARD_PUSH_TOKEN}@github.com/BSMediaGroup/StreamSuites-Dashboard.git
